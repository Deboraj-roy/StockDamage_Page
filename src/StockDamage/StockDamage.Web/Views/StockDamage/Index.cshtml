<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stock Damage</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            background: #f9fafb;
        }

        .readonly {
            background: #e9ecef !important;
        }

        .section-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: .75rem;
            border-left: 4px solid #0d6efd;
            padding-left: 8px;
        }

        .form-label {
            font-weight: 500;
        }

        .card {
            border-radius: 10px;
        }

        .table th {
            background: #f1f3f5;
        }
    </style>
</head>

<body class="p-4">
    <div class="container">

        <div class="mb-4">
            <h2 class="fw-bold text-primary">Stock Damage Entry</h2>
            <small class="text-muted">Record damaged stock with proper valuation</small>
        </div>

        <form id="formDamage" onsubmit="return false;">

            <div class="row g-4">

                <!-- LEFT SIDE -->
                <div class="col-md-6">
                    <div class="card shadow-sm p-4">

                        <div class="section-title">Item & Warehouse Info</div>

                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="txtDate" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Voucher No</label>
                            <input type="text" id="txtVoucherNo" class="form-control readonly" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Warehouse *</label>
                            @Html.DropDownList("ddlWarehouse", (IEnumerable<SelectListItem>)ViewBag.ddlGodowns,
                            "Select Warehouse",
                                                        new { @class = "form-select", id = "ddlWarehouse" })
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Item Name*</label>
                            @Html.DropDownList("ddlSubItemNames", (IEnumerable<SelectListItem>)ViewBag.ddlSubItemNames,
                                                        "Select Item",
                                                        new { @class = "form-select", id = "ddlSubItemNames" })
                        </div>

                        <div class="row mb-3">
                            <div class="col-8">
                                <label class="form-label">Item Code</label>
                                <input id="txtItemCode" class="form-control readonly" readonly />
                            </div>
                            <div class="col-4">
                                <label class="form-label">Unit</label>
                                <input id="txtUnit" class="form-control readonly" readonly />
                            </div>
                        </div>

                        
                        <div class="row mb-3">
                            <div class="col-5">
                                <label class="form-label">Stock ID</label>
                                <input id="txtStockId" class="form-control readonly" readonly />
                            </div>
                            <div class="col-5">
                                <label class="form-label">Available Stock</label>
                                <input id="txtStock" class="form-control readonly" readonly />
                            </div>

                        </div>
                         

                        <div class="mb-3">
                            <label class="form-label">Batch No</label>
                            <select id="txtBatch" class="form-select">
                                <option value="NA">NA</option>
                                <option value="B001">B001</option>
                                <option value="B002">B002</option>
                                <option value="B003">B003</option>
                            </select>
                        </div>

                        <div class="text-end mt-3">
                            <button id="btnAdd" class="btn btn-primary px-4">Add Item</button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDE -->
                <div class="col-md-6">
                    <div class="card shadow-sm p-4">

                        <div class="section-title">Value & Currency</div>

                        <div class="mb-3">
                            <label class="form-label">Currency</label>
                            @Html.DropDownList("ddlCurrency", (IEnumerable<SelectListItem>)ViewBag.ddlCurrency,
                                                        "Select Currency",
                                                        new { @class = "form-select", id = "ddlCurrency" })
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Quantity</label>
                                <input type="number" step="0.0001" id="txtQuantity" class="form-control" />
                            </div>
                            <div class="col-6">
                                <label class="form-label">Rate</label>
                                <input type="number" step="0.0001" id="txtRate" class="form-control" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount In</label>
                            <input id="txtAmountIn" class="form-control readonly" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Exchange Rate (BDT)</label>
                            <input id="txtExchangeRate" class="form-control readonly" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Total Amount (BDT)</label>
                            <input id="txtTotalBDT" class="form-control readonly" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dr A/C Head</label>
                            @* <input id="txtDrAC" class="form-control readonly" value="Stock Damage" /> *@
                            <select id="txtDrAC" class="form-select">
                                <option value="Stock Damage">Stock Damage</option>
                                <option value="Stock New">Stock New</option>
                                <option value="Stock Old">Stock Old</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Employee Name</label>
                            @* <select id="ddlEmployee" class="form-select"></select> *@
                            @Html.DropDownList("ddlEmployee", (IEnumerable<SelectListItem>)ViewBag.ddlEmployees,
                                                        "Select Employee",
                                                        new { @class = "form-select", id = "ddlEmployee" })
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea id="txtComments" class="form-control"></textarea>
                        </div>

                    </div>
                </div>

            </div>

            <!-- TABLE -->
            <div class="card shadow-sm p-4 mt-4">
                <h5 class="section-title">Damage Item List</h5>

                <div class="table-responsive">
                    <table class="table table-bordered" id="tblLines">
                        <thead class="table-light">
                            <tr>
                                <th>SL</th>
                                <th>Warehouse</th>
                                <th>Item</th>
                                <th>Code</th>
                                <th>Batch</th>
                                <th>Curr</th>
                                <th>Qty</th>
                                <th>Rate</th>
                                <th>Amount In</th>
                                <th>Exch</th>
                                <th>Total (BDT)</th>
                                <th width="110">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tblBody"></tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <h5 class="fw-bold">Grand Total: <span id="lblGrandTotal">0.00</span> BDT</h5>
                    <button id="btnSave" class="btn btn-success btn-lg px-4">Save</button>
                </div>
            </div>

        </form>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        var warehouses = [];
        var items = [];
        var currencies = [];
        var employees = [];
        var lines = [];
        var editIndex = -1;
        var txtDate = $("#txtDate");
        var txtVoucherNo = $("#txtVoucherNo");
        var ddlWarehouse = $("#ddlWarehouse");
        var ddlSubItemNames = $("#ddlSubItemNames");
        var txtItemCode = $("#txtItemCode");
        var txtUnit = $("#txtUnit");
        var txtStockId = $("#txtStockId");
        var txtStock = $("#txtStock");
        var txtBatch = $("#txtBatch");
        var ddlCurrency = $("#ddlCurrency");
        var txtQuantity = $("#txtQuantity");
        var txtRate = $("#txtRate");
        var txtAmountIn = $("#txtAmountIn");
        var txtExchangeRate = $("#txtExchangeRate");
        var txtTotalBDT = $("#txtTotalBDT");
        var txtDrAC = $("#txtDrAC");
        var ddlEmployee = $("#ddlEmployee");
        var txtComments = $("#txtComments");
        var exchangeRate = 1;


        $("#ddlSubItemNames").change(function () {

            var itemId = $(this).val();
            console.log(itemId);

            $.ajax({
                url: '/StockDamage/GetItemDetails',
                    type: 'POST',
                    data: { itemId: itemId },  
                    success: function (res) {
                        txtUnit.val(res.unit);
                        txtItemCode.val(res.subItemCode);
                        txtStockId.val(res.stockId);
                        txtStock.val(res.stockqty);
                        console.log(res);
                    },
                error: function (err) {
                    console.error(err);
                }
            });

        });

        $("#ddlCurrency").change(function () {

            var cId = $(this).val();
            console.log(cId);

            $.ajax({
                url: '/StockDamage/GetCurrencyDetails',
                    type: 'POST',
                    data: { cId: cId },
                    success: function (res) {
                        exchangeRate = res.conversionRate || 0;
                        // var finalRate = exchangeRate * (txtAmountIn.val() || 0);
                        debugger;
                        txtExchangeRate.val(exchangeRate);
                        console.log(res);
                        console.log(txtExchangeRate.val());
                    },
                error: function (err) {
                    console.error(err);
                }
            });

        });


        $("#txtAmountIn").change(function () {
           recalc();
        });

        $(function () {
            $('#txtDate').val(new Date().toISOString().slice(0,10));
            loadAll();

            $('#ddlItem').on('change', onItemChange);
            $('#ddlWarehouse,#ddlItem').on('change', updateStock);
            $('#ddlCurrency').on('change', onCurrencyChange);
            $('#txtQuantity,#txtRate').on('input', recalc);
            $('#btnAdd').on('click', onAdd);
            $('#btnSave').on('click', onSave);
        });

        function loadAll() {
            // $.getJSON('/StockDamage/GetWarehouses').done(data => { warehouses = data; fillWarehouses(); });
            // $.getJSON('/StockDamage/GetItems').done(data => { items = data; fillItems(); });
            // $.getJSON('/StockDamage/GetCurrencies').done(data => { currencies = data; fillCurrencies(); });
            // $.getJSON('/StockDamage/GetEmployees').done(data => { employees = data; fillEmployees(); });
        }

        function fillWarehouses() {
            var ddl = $('#ddlWarehouse');
            ddl.empty().append('<option value="">--Select--</option>');
            warehouses.forEach(w => ddl.append($('<option>').val(w.autoSlNo || w.AutoSlNo).text(w.godownName || w.GodownName)));
        }

        function fillItems() {
            let ddl = $('#ddlItem'); ddl.empty().append('<option value="">--Select--</option>');
            items.forEach(i => ddl.append($('<option>').val(i.autoSlNo || i.AutoSlNo).text(i.subItemName || i.SubItemName)));
        }

        function fillCurrencies() {
            let ddl = $('#ddlCurrency'); ddl.empty();
            currencies.forEach(c => ddl.append($('<option>').val(c.currencyName || c.CurrencyName).text(c.currencyName || c.CurrencyName)));
            $('#ddlCurrency').val('BDT').trigger('change');
        }

        function fillEmployees() {
            let ddl = $('#ddlEmployee'); ddl.empty().append('<option value="">--Select--</option>');
            employees.forEach(e => ddl.append($('<option>').val(e.employeeID || e.EmployeeID).text(e.employeeName || e.EmployeeName)));
        }

        function onItemChange() {
            const id = $('#ddlItem').val();
            if (!id) { $('#txtItemCode,#txtUnit').val(''); return; }
            $.getJSON('/StockDamage/GetItemDetails', { itemId: id }).done(item => {
                $('#txtItemCode').val(item.subItemCode || item.SubItemCode);
                $('#txtUnit').val(item.unit || item.Unit);
                updateStock();
            });
        }

        function updateStock() {
            const w = $('#ddlWarehouse').val(); const i = $('#ddlItem').val();
            $('#txtStock').val('');
            if (!w || !i) return;
            $.getJSON('/StockDamage/GetStock', { warehouseId: w, itemId: i }).done(s => {
                $('#txtStock').val((s.quantity || s.Quantity || 0).toFixed(4));
            });
        }

        function onCurrencyChange() {
            var cur = $('#ddlCurrency').val();
            var obj = currencies.find(c => (c.currencyName || c.CurrencyName) === cur);
            $('#txtExchangeRate').val(obj ? (obj.conversionRate || obj.ConversionRate).toFixed(4) : '');
            recalc();
        }

        function recalc() {
            var qty = parseFloat($('#txtQuantity').val()) || 0;
            var rate = parseFloat($('#txtRate').val()) || 0;
            var amountIn = qty * rate;
            $('#txtAmountIn').val(amountIn.toFixed(4));
            
            
            debugger;
            var exch = parseFloat($('#txtExchangeRate').val()) || 0;
            var bdExchangeRate = exch * amountIn;
            $('#txtTotalBDT').val(bdExchangeRate.toFixed(4));

            console.log(exch);


            $('#txtTotalBDT').val((amountIn * exch).toFixed(4));
        }

        function onAdd(e) {
            e.preventDefault();
            var wId = $('#ddlWarehouse').val();
            var wName = $('#ddlWarehouse option:selected').text();
            var iId = $('#ddlSubItemNames').val();
            var iName = $('#ddlSubItemNames option:selected').text();
            var code = $('#txtItemCode').val(); 
            var unit = $('#txtUnit').val();
            var batch = $('#txtBatch').val() || 'NA';
            var curr = $('#ddlCurrency').val();
            var qty = parseFloat($('#txtQuantity').val()) || 0;
            var rate = parseFloat($('#txtRate').val()) || 0;
            var amtIn = parseFloat($('#txtAmountIn').val()) || 0;
            var exch = parseFloat($('#txtExchangeRate').val()) || 0;
            var total = parseFloat($('#txtTotalBDT').val()) || 0;
            var stock = parseFloat($('#txtStock').val()) || 0;

            if (!wId) { alert('Select Warehouse'); return; }
            if (!iId) { alert('Select Item'); return; }
            if (qty <= 0) { alert('Quantity must be > 0'); return; }
            if (qty > stock) { alert('Quantity cannot exceed stock: ' + stock.toFixed(4)); return; }

            var obj = {
                GodownAutoSlNo: parseInt(wId),
                GodownName: wName,
                SubItemAutoSlNo: parseInt(iId),
                SubItemName: iName,
                ItemCode: code,
                Unit: unit,
                BatchNo: batch,
                Currency: curr,
                Quantity: qty,
                Rate: rate,
                AmountIn: amtIn,
                ExchangeRate: exch,
                AmountBDT: total
            };

            if (editIndex >= 0) { lines[editIndex] = obj; editIndex = -1; } else lines.push(obj);
            clearInputs();
            renderTable();
        }

        function clearInputs() {
            $('#ddlWarehouse').val('');
            $('#ddlSubItemNames').val('');
            $('#txtItemCode,#txtUnit,#txtStock,#txtQuantity,#txtRate,#txtAmountIn,#txtTotalBDT').val('');
            $('#txtBatch').val('NA');
            $('#ddlCurrency').val('BDT').trigger('change');
        }

        function renderTable() {
            const tbody = $('#tblBody'); tbody.empty();
            var grand = 0;
            lines.forEach((l, idx) => {
                grand += l.AmountBDT;
                const tr = $('<tr>');
                tr.append($('<td>').text(idx + 1));
                tr.append($('<td>').text(l.GodownName));
                tr.append($('<td>').text(l.SubItemName));
                tr.append($('<td>').text(l.ItemCode));
                tr.append($('<td>').text(l.BatchNo));
                tr.append($('<td>').text(l.Currency));
                tr.append($('<td>').text(l.Quantity.toFixed(4)));
                tr.append($('<td>').text(l.Rate.toFixed(4)));
                tr.append($('<td>').text(l.AmountIn.toFixed(4)));
                tr.append($('<td>').text(l.ExchangeRate.toFixed(4)));
                tr.append($('<td>').text(l.AmountBDT.toFixed(4)));
                const editBtn = $('<button>').addClass('btn btn-sm btn-outline-primary me-1').text('Edit').click(()=>editRow(idx));
                const delBtn = $('<button>').addClass('btn btn-sm btn-outline-danger').text('Delete').click(()=>deleteRow(idx));
                tr.append($('<td>').append(editBtn).append(delBtn));
                tbody.append(tr);
            });
            $('#lblGrandTotal').text(grand.toFixed(4));
        }

        function editRow(i) {
            const l = lines[i];
            editIndex = i;
            $('#ddlWarehouse').val(l.GodownAutoSlNo);
            $('#ddlItem').val(l.SubItemAutoSlNo).trigger('change');
            $('#txtItemCode').val(l.ItemCode);
            $('#txtUnit').val(l.Unit);
            $('#txtQuantity').val(l.Quantity);
            $('#txtRate').val(l.Rate);
            $('#txtAmountIn').val(l.AmountIn.toFixed(4));
            $('#txtExchangeRate').val(l.ExchangeRate.toFixed(4));
            $('#txtTotalBDT').val(l.AmountBDT.toFixed(4));
            $('#txtBatch').val(l.BatchNo);
            $('#ddlCurrency').val(l.Currency);
            updateStock();
        }

        function deleteRow(i) {
            if (!confirm('Delete row?')) return;
            lines.splice(i,1); renderTable();
        }

        function onSave() {
            if (!lines.length) { alert('No lines to save'); return; }
            const req = {
                date: $('#txtDate').val(),
                employeeID: $('#ddlEmployee').val() ? parseInt($('#ddlEmployee').val()) : null,
                comments: $('#txtComments').val(),
                lines: lines.map(l => ({
                    GodownAutoSlNo: l.GodownAutoSlNo,
                    SubItemAutoSlNo: l.SubItemAutoSlNo,
                    BatchNo: l.BatchNo,
                    Currency: l.Currency,
                    Quantity: l.Quantity,
                    Rate: l.Rate,
                    AmountIn: l.AmountIn,
                    ExchangeRate: l.ExchangeRate,
                    AmountBDT: l.AmountBDT
                }))
            };

            $.ajax({
                url: '/StockDamage/Save',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(req),
                success: function (res) {
                    if (res.success) {
                        $('#txtVoucherNo').val(res.voucherNo);
                        alert('Saved. Voucher: ' + res.voucherNo);
                        lines = []; renderTable(); $('#txtComments').val('');
                    } else {
                        alert('Save failed: ' + (res.message || 'Unknown'));
                    }
                },
                error: function(xhr) {
                    alert('Save error: ' + (xhr.responseJSON?.message || xhr.responseText || 'Server error'));
                }
            });
        }
    </script>
</body>
</html>